---
title: "Project 2"
author: "Justin Feathers & Luke Perkins"
date: "2022-10-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE)
library(httr)
library(tidyverse)
library(jsonlite)
```

# Requirements

The following packages were used to create this document:
  + `knitr`: used to document code in R Markdown format
  + `httr`: used to connect to the API
  + `tidyverse`: used for pipe operators and plotting
  + `jsonlite`: used for interacting with JSON in the API

## API Functions

Search breweries by city

```{r}
by_city <- function(city){
  if (!is.character(city)){
    stop("city must be a character string")
  }
  base <- "https://api.openbrewerydb.org/breweries"
  url <- paste0(base, "?by_city=", city)
  city_df <- fromJSON(rawToChar(GET(url)$content))
  if (length(city_df) == 0 ){
    message("No results found. Try a different city.")
  }
  else {
    return(city_df)
  }
}
```

Search breweries by name. Can search by parts of the brewery name.

```{r}
by_name <- function(brewery){
  if (!is.character(brewery)){
    stop("brewery must be a character string")
  }
  base <- "https://api.openbrewerydb.org/breweries"
  url <- paste0(base, "?by_name=", brewery)
  brew_df <- fromJSON(rawToChar(GET(url)$content))
  if (length(brew_df) == 0 ){
    message("No results found. Try a different brewery.")
  }
  else {
    return(brew_df)
  }
}
```

Search breweries by state

```{r}
by_state <- function(state, usa = TRUE){
  if (!is.character(state)){
    stop("state must be a character string")
  }
  if (usa){
    if (nchar(state) == 2){
      state <- toupper(state)
      switch(state,
                    AL =  state <- "Alabama",
                    AK =  state <- "Alaska",
                    AZ =  state <- "Arizona",
                    AR =  state <- "Arkansas",
                    CA =  state <- "California",
                    CO =  state <- "Colorado",
                    CT =  state <- "Connecticut",
                    DE =  state <- "Delaware",
                    DC =  state <- "District_of_Columbia",
                    FL =  state <- "Florida",
                    GA =  state <- "Georgia",
                    HI =  state <- "Hawaii",
                    ID =  state <- "Idaho",
                    IL =  state <- "Illinois",
                    IN =  state <- "Indiana",
                    IA =  state <- "Iowa",
                    KS =  state <- "Kansas",
                    KY =  state <- "Kentucky",
                    LA =  state <- "Louisiana",
                    ME =  state <- "Maine",
                    MD =  state <- "Maryland",
                    MA =  state <- "Massachusetts",
                    MI =  state <- "Michigan",
                    MN =  state <- "Minnesota",
                    MS =  state <- "Mississippi",
                    MO =  state <- "Missouri",
                    MT =  state <- "Montana",
                    NE =  state <- "Nebraska",
                    NV =  state <- "Nevada",
                    NH =  state <- "New_Hampshire",
                    NJ =  state <- "New_Jersey",
                    NM =  state <- "New_Mexico",
                    NY =  state <- "New_York",
                    NC =  state <- "North_Carolina",
                    ND =  state <- "North_Dakota",
                    OH =  state <- "Ohio",
                    OK =  state <- "Oklahoma",
                    OR =  state <- "Oregon",
                    PA =  state <- "Pennsylvania",
                    PR =  state <- "Puerto_Rico",
                    RI =  state <- "Rhode_Island",
                    SC =  state <- "South_Carolina",
                    SD =  state <- "South_Dakota",
                    TN =  state <- "Tennessee",
                    TX =  state <- "Texas",
                    UT =  state <- "Utah",
                    VT =  state <- "Vermont",
                    VA =  state <- "Virginia",
                    WA =  state <- "Washington",
                    WV =  state <- "West_Virginia",
                    WI =  state <- "Wisconsin",
                    WY =  state <- "Wyoming",
                    stop("usa state must be a 2 character abbreviation or name")
             )
    }
  }
  base <- "https://api.openbrewerydb.org/breweries"
  url <- paste0(base, "?by_state=", state)
  state_df <- fromJSON(rawToChar(GET(url)$content))
  if (length(state_df) == 0 ){
    message("No results found. Try a different state.")
  }
  else {
    return(state_df)
  }
}
```

By type of brewery

```{r}
by_type <- function(type){
  if (!is.character(type)){
    stop("type must be a character string")
  }
  type <- tolower(type)
  type_list <- c("micro", "nano", "regional", "brewpub", "large", "planning",
                    "bar", "contract", "proprietor", "closed")
  if (!(type %in% type_list)){
    stop("type must be either micro, nano, regional, brewpub, large, planning, bar, contract, proprietor, or closed")
  }
  base <- "https://api.openbrewerydb.org/breweries"
  url <- paste0(base, "?by_type=", type)
  type_df <- fromJSON(rawToChar(GET(url)$content))
  if (length(type_df) == 0 ){
    message("No results found. Try a different type.")
  }
  else {
    return(type_df)
  }
}
```

```{r}
by_postal <- function(postal){
  if (!is.numeric(postal)){
    stop("Postal code must be a 5 or 9 digit number")
  }
  else {
    if ((nchar(postal) != 5) & (nchar(postal) != 9)){
      stop("Postal code must be a 5 or 9 digit number")
    }
    else {
      base <- "https://api.openbrewerydb.org/breweries"
      if (nchar(postal) == 9){
        newpostal <- sub("(.{5})(.*)", "\\1-\\2", postal)
        url <- paste0(base, "?by_postal=", newpostal)
        postal_df <- fromJSON(rawToChar(GET(url)$content))
      }
      if (nchar(postal) == 5){
        url <- paste0(base, "?by_postal=", postal)
        postal_df <- fromJSON(rawToChar(GET(url)$content))
      }
      if (length(postal_df) == 0){
      message("No results found. Try a different postal code.")
    }
      else {
        return(postal_df)
      }
    }
  }
}
```

```{r}
by_dist <- function(latitude, longitude){
  if ((!is.numeric(latitude)) | (!is.numeric(longitude))){
    stop("Latitude and longitude must be numeric values")
  }
  else {
    base <- "https://api.openbrewerydb.org/breweries"
    url <- paste0(base, "?by_dist=", latitude, ",", longitude)
    dist_df <- fromJSON(rawToChar(GET(url)$content))
    if (length(dist_df) == 0 ){
    message("No results found. Try different latitude and/or longitude.")
      }
      else {
        return(dist_df)
      }
    }
  }
```

Wrapper function

Default pulls breweries

```{r}
get_brewery <- function(city = NULL, state = NULL, usa = TRUE, type = NULL, 
                        name = NULL, postal = NULL, latitude = NULL, 
                        longitude = NULL){
  url <- "https://api.openbrewerydb.org/breweries?per_page=50"

  if (!is.null(city)){
    if (!is.character(city)){
      stop("city must be a character string")
    }
    url <- paste0(url, "&by_city=", str_replace_all(city, " ", "_"))
  }
  
  if (!is.null(type)){
    if (!is.character(type)){
      stop("type must be a character string")
    }
    type <- tolower(type)
    type_list <- c("micro", "nano", "regional", "brewpub", "large", "planning",
                    "bar", "contract", "proprietor", "closed")
    if (!(type %in% type_list)){
    stop("type must be either micro, nano, regional, brewpub, large, planning, bar, contract, proprietor, or closed")
    }
    url <- paste0(url, "&by_type=", str_replace_all(type, " ", "_"))
  }
  
  if (!is.null(name)){
    if (!is.character(name)){
      stop("brewery must be a character string")
    }
    url <- paste0(url, "&by_name=", name)
  }
  
  if(!is.null(state)){
    if (!is.character(state)){
      stop("state must be a character string")
    }
    if (usa){
      if (nchar(state) == 2){
        state <- toupper(state)
        switch(state,
                      AL =  state <- "Alabama",
                      AK =  state <- "Alaska",
                      AZ =  state <- "Arizona",
                      AR =  state <- "Arkansas",
                      CA =  state <- "California",
                      CO =  state <- "Colorado",
                      CT =  state <- "Connecticut",
                      DE =  state <- "Delaware",
                      DC =  state <- "District_of_Columbia",
                      FL =  state <- "Florida",
                      GA =  state <- "Georgia",
                      HI =  state <- "Hawaii",
                      ID =  state <- "Idaho",
                      IL =  state <- "Illinois",
                      IN =  state <- "Indiana",
                      IA =  state <- "Iowa",
                      KS =  state <- "Kansas",
                      KY =  state <- "Kentucky",
                      LA =  state <- "Louisiana",
                      ME =  state <- "Maine",
                      MD =  state <- "Maryland",
                      MA =  state <- "Massachusetts",
                      MI =  state <- "Michigan",
                      MN =  state <- "Minnesota",
                      MS =  state <- "Mississippi",
                      MO =  state <- "Missouri",
                      MT =  state <- "Montana",
                      NE =  state <- "Nebraska",
                      NV =  state <- "Nevada",
                      NH =  state <- "New_Hampshire",
                      NJ =  state <- "New_Jersey",
                      NM =  state <- "New_Mexico",
                      NY =  state <- "New_York",
                      NC =  state <- "North_Carolina",
                      ND =  state <- "North_Dakota",
                      OH =  state <- "Ohio",
                      OK =  state <- "Oklahoma",
                      OR =  state <- "Oregon",
                      PA =  state <- "Pennsylvania",
                      PR =  state <- "Puerto_Rico",
                      RI =  state <- "Rhode_Island",
                      SC =  state <- "South_Carolina",
                      SD =  state <- "South_Dakota",
                      TN =  state <- "Tennessee",
                      TX =  state <- "Texas",
                      UT =  state <- "Utah",
                      VT =  state <- "Vermont",
                      VA =  state <- "Virginia",
                      WA =  state <- "Washington",
                      WV =  state <- "West_Virginia",
                      WI =  state <- "Wisconsin",
                      WY =  state <- "Wyoming",
                      stop("usa state must be a 2 character abbreviation or name")
               )
      }
    }
    url <- paste0(url, "&by_state=", state)
  }
  
  if (!is.null(postal)){
    if ((!is.character(postal)) | 
        ((nchar(postal) != 5) & 
         (nchar(postal) != 10))){
      stop("Postal code must be a 5 or 10 character string in the form \"12345-6789\" or \"12345\"")
    }
    url <- paste0(url, "&by_postal=", postal)
  }
  
  if ((!is.null(latitude)) & (!is.null(longitude))){
    if ((!is.numeric(latitude)) | (!is.numeric(longitude))){
      stop("Latitude and longitude must be numeric values")
    }
    url <- paste0(url, "&by_dist=", latitude, ",", longitude)
  }

  df <- fromJSON(rawToChar(GET(url)$content))
  if (length(df) == 0 ){
    message("No results found. Try different parameters")
  }
  else {
    return(df)
  }
}
```

Derive Region variable from state, make contingency tables, create bar graph.

```{r}
brew <- get_brewery()

brew_reg <- brew %>%
  mutate(Region = 
    if_else(brew$state %in%
    c("Connecticut", "Maine", "Massachusetts", "New Hampshire", "Rhode Island", 
      "Vermont", "New Jersey", "New York", "Pennsylvania"),
    "Northeast",
    if_else(brew$state %in%
    c("Illinois", "Indiana", "Michigan", "Ohio", "Wisconsin", "Iowa", "Kansas", 
      "Minnesota", "Missouri", "Nebraska", "North Dakota", "South Dakota"),
    "Midwest",
    if_else(brew$state %in%
    c("Delaware", "Florida", "Georgia", "Maryland", "North Carolina",
      "South Carolina", "Virginia", "Washington D.C.", "West Virginia", 
      "Alabama", "Kentucky", "Mississippi", "Tennessee", "Arkansas",
      "Louisiana", "Oklahoma", "Texas"),
    "South",
    if_else(brew$state %in%
    c("Arizona", "Colorado", "Idaho", "Montana", "Nevada", "New Mexico", "Utah",
      "Wyoming", "Alaska", "California","Hawaii","Oregon","Washington"),
    "West", 
    "Not US"))))) %>%
  select(id:state, Region, everything())

table(brew_reg$Region)
table(brew_reg$brewery_type)
table(brew_reg$Region, brew_reg$brewery_type)

g <- ggplot(brew_reg, aes(x = Region))
g + geom_bar(aes(fill = brewery_type)) +
    labs(x = "Geographic Region",
         y = "Number of Breweries",
         title = "Bar Plot of Breweries by US Region") + 
    scale_fill_discrete(name = "Brewery Type", 
                        labels = c("Brewpub", "Closed", "Contract", "Large",
                                   "Micro", "Proprietor")
  )

micro <- get_brewery(type = "micro")
large <- get_brewery(type = "large")
combined <- bind_rows(micro, large)

```
