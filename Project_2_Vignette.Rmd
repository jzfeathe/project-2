---
title: "Project 2"
author: "Justin Feathers & Luke Perkins"
date: "2022-10-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE)
library(httr)
library(tidyverse)
library(jsonlite)
```

# Requirements

The following packages were used to create this document:
  + `knitr`: used to document code in R Markdown format
  + `httr`: used to connect to the API
  + `tidyverse`: used for pipe operators and plotting
  + `jsonlite`: used for interacting with JSON in the API

# API Function

Default pulls breweries

```{r}
get_brewery <- function(city = NULL, state = NULL, usa = TRUE, type = NULL, 
                        name = NULL, postal = NULL, latitude = NULL, 
                        longitude = NULL){
  url <- "https://api.openbrewerydb.org/breweries?per_page=50"

  if (!is.null(city)){
    if (!is.character(city)){
      stop("city must be a character string")
    }
    url <- paste0(url, "&by_city=", str_replace_all(city, " ", "_"))
  }
  
  if (!is.null(type)){
    if (!is.character(type)){
      stop("type must be a character string")
    }
    type <- tolower(type)
    type_list <- c("micro", "nano", "regional", "brewpub", "large", "planning",
                    "bar", "contract", "proprietor", "closed")
    if (!(type %in% type_list)){
    stop("type must be either micro, nano, regional, brewpub, large, planning, bar, contract, proprietor, or closed")
    }
    url <- paste0(url, "&by_type=", str_replace_all(type, " ", "_"))
  }
  
  if (!is.null(name)){
    if (!is.character(name)){
      stop("brewery must be a character string")
    }
    url <- paste0(url, "&by_name=", name)
  }
  
  if(!is.null(state)){
    if (!is.character(state)){
      stop("state must be a character string")
    }
    if (usa){
      if (nchar(state) == 2){
        state <- toupper(state)
        switch(state,
                      AL =  state <- "Alabama",
                      AK =  state <- "Alaska",
                      AZ =  state <- "Arizona",
                      AR =  state <- "Arkansas",
                      CA =  state <- "California",
                      CO =  state <- "Colorado",
                      CT =  state <- "Connecticut",
                      DE =  state <- "Delaware",
                      DC =  state <- "District_of_Columbia",
                      FL =  state <- "Florida",
                      GA =  state <- "Georgia",
                      HI =  state <- "Hawaii",
                      ID =  state <- "Idaho",
                      IL =  state <- "Illinois",
                      IN =  state <- "Indiana",
                      IA =  state <- "Iowa",
                      KS =  state <- "Kansas",
                      KY =  state <- "Kentucky",
                      LA =  state <- "Louisiana",
                      ME =  state <- "Maine",
                      MD =  state <- "Maryland",
                      MA =  state <- "Massachusetts",
                      MI =  state <- "Michigan",
                      MN =  state <- "Minnesota",
                      MS =  state <- "Mississippi",
                      MO =  state <- "Missouri",
                      MT =  state <- "Montana",
                      NE =  state <- "Nebraska",
                      NV =  state <- "Nevada",
                      NH =  state <- "New_Hampshire",
                      NJ =  state <- "New_Jersey",
                      NM =  state <- "New_Mexico",
                      NY =  state <- "New_York",
                      NC =  state <- "North_Carolina",
                      ND =  state <- "North_Dakota",
                      OH =  state <- "Ohio",
                      OK =  state <- "Oklahoma",
                      OR =  state <- "Oregon",
                      PA =  state <- "Pennsylvania",
                      PR =  state <- "Puerto_Rico",
                      RI =  state <- "Rhode_Island",
                      SC =  state <- "South_Carolina",
                      SD =  state <- "South_Dakota",
                      TN =  state <- "Tennessee",
                      TX =  state <- "Texas",
                      UT =  state <- "Utah",
                      VT =  state <- "Vermont",
                      VA =  state <- "Virginia",
                      WA =  state <- "Washington",
                      WV =  state <- "West_Virginia",
                      WI =  state <- "Wisconsin",
                      WY =  state <- "Wyoming",
                      stop("usa state must be a 2 character abbreviation or name")
               )
      }
    }
    url <- paste0(url, "&by_state=", state)
  }
  
  if (!is.null(postal)){
    if ((!is.character(postal)) | 
        ((nchar(postal) != 5) & 
         (nchar(postal) != 10))){
      stop("Postal code must be a 5 or 10 character string in the form \"12345-6789\" or \"12345\"")
    }
    url <- paste0(url, "&by_postal=", postal)
  }
  
  if ((!is.null(latitude)) & (!is.null(longitude))){
    if ((!is.numeric(latitude)) | (!is.numeric(longitude))){
      stop("Latitude and longitude must be numeric values")
    }
    url <- paste0(url, "&by_dist=", latitude, ",", longitude)
  }

  df <- fromJSON(rawToChar(GET(url)$content))
  if (length(df) == 0 ){
    message("No results found. Try different parameters")
  }
  else {
    return(df)
  }
}
```
#Exploratory Data Analysis
Now that we can access the endpoint with up to six different modifications, we can get some data
to analyze. Let's start by grabbing some data without any modifications using `get_brewery()`
```{r}
noMod <- get_brewery()
```

Given that most of the results are from the U.S., it seems reasonable to assume we should land
somewhere in Kansas (the center of the U.S.) using the means of the latitudes and longitudes 
if the results from the call are representative -- that is, they are unbiased and evenly spread.
```{r}
usDist <- noMod %>%
  select(name, city, state, latitude, longitude) %>%
  mutate(meanLat = mean(as.numeric(latitude), na.rm = TRUE), 
         meanLong = mean(as.numeric(longitude), na.rm = TRUE),
         distFromMean = sqrt(((as.numeric(latitude) - meanLat)^2) +
           ((as.numeric(longitude)- meanLong)^2)))
usDist
```

How did we do? We can do another call using `get_brewery(state = "kansas")` to check.
We can compare `meanLat` and `meanLong` with the latitude and longitude values from
breweries located in Kansas.
```{r}
get_brewery(state = "kansas") %>%
  select(latitude, longitude)
```

We were close, but not quite what we were hoping for. Some knowledge of geography
lets us know we are just slightly north into the bordering state of Nebraska. But,
we can also perform another call using `get_brewery(state = "nebraska")` to verify.

```{r}
get_brewery(state = "nebraska") %>%
  select(latitude, longitude)
```

We can see that these values more closely align with the means we found. So what
happened? If we look back at `usDist`, we can see one glaring outlier from 
Killeshin, Ireland. Let's remove that and see if our results are better.

```{r}
noMod %>%
  select(name, city, state, latitude, longitude) %>%
  filter(city != "Killeshin") %>%
  mutate(meanLat = mean(as.numeric(latitude), na.rm = TRUE), 
         meanLong = mean(as.numeric(longitude), na.rm = TRUE),
         distFromMean = sqrt(((as.numeric(latitude) - meanLat)^2) +
           ((as.numeric(longitude)- meanLong)^2))) %>%
  arrange(state)
```

Now we are a bit further away than expected, so it appears that although close, this
data is not quite representative or unbiased. Visual inspection of the tibble shows
us that 6 results are from Oregon, with California and Colorado having 4 each; it
seems reasonable to assume this is why our means are northwest of where we expected.

A visual representation can help solidify our findings. We can use a histogram for this.
Here is a histogram including the brewery from Ireland. Though clearly skewed right here,
it looks like it could be considered nearly normally-distributed without the outlier.
The x-axis shows us the distance from the mean and each bar's height represents the
frequency that breweries were that corresponding distance from the mean.

```{r}
g <- ggplot(usDist, aes(x = distFromMean))
g + geom_histogram() 
```
Here is the histogram without the brewery from Ireland. Again, it looks nearly
normally-distributed. This indicates that it is nearly representative of the population.
As the above histogram, the x-axis is the distance from the mean and the y-axis consists
of the corresponding frequencies of breweries' distances from the mean.

```{r}
g <- ggplot(na.omit(usDist), aes(x = distFromMean))
g + geom_histogram()
```



Next, let's look at some more specific data by calling the function `get_brewery(state = "ny")` to get brewery data
for the state of New York.
```{r}
#Get brewery data for NY
ny <- get_brewery(state = "ny")
```

We want to see if there are any patterns by type of brewery. To do this, we will investigate
latitude and longitude values across brewery types. Additionally, we may want to look at
the means of each type to see if they have significant variance.
```{r}
nyDist <- ny %>% 
  select(name, brewery_type, latitude, longitude) %>%
  group_by(brewery_type) %>%
  mutate(meanLat = mean(as.numeric(latitude), na.rm = TRUE), 
         meanLong = mean(as.numeric(longitude), na.rm = TRUE)) %>%
  arrange(meanLat)
nyDist
```

Now that we have the data, let's create a scatter plot to look for obvious patterns.
```{r}
g <- ggplot(na.omit(nyDist), aes(x = longitude, y = latitude))
g + geom_point(aes(color = brewery_type)) +
    labs(color = "Brewery Type", x = "Longitude", y = "Latitude") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
    labs(title = "NY Breweries by Type", hjust = 0.5) +
    theme(plot.title = element_text(hjust = 0.5))
```

There doesn't appear to be any sort of obvious pattern that would suggest a preference
of location to build a brewery, but there are clusters or groups of breweries by type.
We believe this suggests the influence of competition. 
```{r}
nyDist %>%
  summarize(meanLat = mean(as.numeric(latitude), na.rm = TRUE), 
            meanLong = mean(as.numeric(longitude), na.rm = TRUE),
            sdLat = sd(latitude, na.rm = TRUE), sdLong = sd(longitude, na.rm = TRUE))
```

=======
Derive Region variable from state, make contingency tables, create bar graph.

```{r}
brew <- get_brewery()

brew_reg <- brew %>%
  mutate(Region = 
    if_else(brew$state %in%
    c("Connecticut", "Maine", "Massachusetts", "New Hampshire", "Rhode Island", 
      "Vermont", "New Jersey", "New York", "Pennsylvania"),
    "Northeast",
    if_else(brew$state %in%
    c("Illinois", "Indiana", "Michigan", "Ohio", "Wisconsin", "Iowa", "Kansas", 
      "Minnesota", "Missouri", "Nebraska", "North Dakota", "South Dakota"),
    "Midwest",
    if_else(brew$state %in%
    c("Delaware", "Florida", "Georgia", "Maryland", "North Carolina",
      "South Carolina", "Virginia", "Washington D.C.", "West Virginia", 
      "Alabama", "Kentucky", "Mississippi", "Tennessee", "Arkansas",
      "Louisiana", "Oklahoma", "Texas"),
    "South",
    if_else(brew$state %in%
    c("Arizona", "Colorado", "Idaho", "Montana", "Nevada", "New Mexico", "Utah",
      "Wyoming", "Alaska", "California","Hawaii","Oregon","Washington"),
    "West", 
    "Not US"))))) %>%
  select(id:state, Region, everything())

table(brew_reg$Region)
table(brew_reg$brewery_type)
table(brew_reg$Region, brew_reg$brewery_type)

g <- ggplot(brew_reg, aes(x = Region))
g + geom_bar(aes(fill = brewery_type)) +
    labs(x = "Geographic Region",
         y = "Number of Breweries",
         title = "Bar Plot of Breweries by US Region") + 
    scale_fill_discrete(name = "Brewery Type", 
                        labels = c("Brewpub", "Closed", "Contract", "Large",
                                   "Micro", "Proprietor")
                        )

micro <- get_brewery(type = "micro")
large <- get_brewery(type = "large")
combined <- bind_rows(micro, large)

g <- ggplot(combined, aes(x = brewery_type, y = as.numeric(latitude)))
g + geom_boxplot(fill = "red", na.rm = TRUE) +
    geom_jitter() +
    labs(title = "Boxplot of Latitudes by Brewery Type",
         x = "Brewery Type",
         y = "Latitude in Degrees")

g <- ggplot(combined, aes(x = brewery_type, y = as.numeric(longitude)))
g + geom_boxplot(fill = "blue", na.rm = TRUE) +
    geom_jitter() +
    coord_flip() +
    labs(title = "Boxplot of Longitudes by Brewery Type",
         x = "Brewery Type",
         y = "Longitude in Degrees")

```
